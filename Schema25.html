<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <title>Example News Page</title>
  <meta name="description" content="Ye sample news article ka description hai." />
  <meta name="author" content="Aksh G" />
  <meta property="og:image" content="https://example.com/sample-image.jpg" />
  <meta property="og:site_name" content="MeraNewsSite" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    article img { max-width: 100%; height: auto; display:block; margin: 1rem 0; }
    .schema-debug { background:#f4f4f4; padding:10px; border-radius:6px; font-family:monospace; white-space:pre-wrap; }
  </style>
</head>
<body>
<img src="https://blogger.googleusercontent.com/img/a/AVvXsEgVCKUZH3FMnzIjVRpDn3OHQVY6pVwIpgBtRpgDxShMQ4yu2Felyyru3PmasPXCe2ygdzMHQ-YBmDUJpVGCtMX6DnkhN9sT8BcpyFEpE_Bx9o3khWgHalkic86pLSBBCtPQQaX21l5XY3KKBlJxa3OFHhe7o-naKyRPOS324jy4nKGdDXljWn3qfmTVOQ" alt="" width="400">
<article id="article">
  <h1 id="title">Sample News: JavaScript se Automatic Schema</h1>
  <p class="byline"><span class="author">By: Rahul Sharma</span> â€¢ <time datetime="2025-08-10" class="published">August 10, 2025</time></p>
  <p>Yeh ek sample article ka pehla paragraph hai. Yahan se description generate hoga agar meta description available nahi hai.</p>
  <img src="https://example.com/news-photo.jpg" alt="news photo">
  <p>Article ka baki content yahan hoga...</p>
  <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgVCKUZH3FMnzIjVRpDn3OHQVY6pVwIpgBtRpgDxShMQ4yu2Felyyru3PmasPXCe2ygdzMHQ-YBmDUJpVGCtMX6DnkhN9sT8BcpyFEpE_Bx9o3khWgHalkic86pLSBBCtPQQaX21l5XY3KKBlJxa3OFHhe7o-naKyRPOS324jy4nKGdDXljWn3qfmTVOQ" alt="" width="400">
</article>

<h2>Generated Schema (debug)</h2>
<div id="schemaDebug" class="schema-debug"></div>

<script>
(function(){
  // Utility helpers
  const iso = d => (d ? (new Date(d)).toISOString() : null);
  const textOrNull = (el) => el ? el.textContent.trim() : null;
  const firstMatch = (selectors, root=document) => {
    for(const s of selectors){
      const el = root.querySelector(s);
      if(el) return el;
    }
    return null;
  };

  function detectPrimaryImage() {
    // Try common places: og:image meta, first img inside article, images with role/main, link rel=image_src
    const og = document.querySelector('meta[property="og:image"]')?.content;
    if(og) return og;
    const linkImg = document.querySelector('link[rel="image_src"]')?.href;
    if(linkImg) return linkImg;
    // prefer images inside article if present
    const article = document.querySelector('article') || document.body;
    const imgs = article.querySelectorAll('img');
    if(imgs && imgs.length) {
      // choose largest by naturalWidth if available, else first
      let best = imgs[0];
      for(const img of imgs) {
        try {
          if(img.naturalWidth && best.naturalWidth && img.naturalWidth > best.naturalWidth) best = img;
        } catch(e){}
      }
      return best.src || null;
    }
    // fallback: favicon (not ideal)
    const icon = document.querySelector('link[rel~="icon"]')?.href;
    return icon || null;
  }

  function detectTitle() {
    // h1 in article, meta og:title, document.title
    const h1 = firstMatch(['article h1', '#title', 'h1']);
    if(h1) return textOrNull(h1);
    const og = document.querySelector('meta[property="og:title"]')?.content;
    if(og) return og;
    return document.title || null;
  }

  function detectDescription() {
    const meta = document.querySelector('meta[name="description"]')?.content;
    if(meta) return meta;
    // first paragraph of article
    const p = firstMatch(['article p', '#article p', 'main p', 'p']);
    if(p) return textOrNull(p).slice(0, 300);
    return null;
  }

  function detectAuthor() {
    // meta author, .author class, byline text
    const m = document.querySelector('meta[name="author"]')?.content;
    if(m) return m;
    const authorEl = firstMatch(['.author', '.byline .author', '[itemprop="author"]']);
    if(authorEl) {
      return textOrNull(authorEl).replace(/^By[:\s]*/i, '');
    }
    return null;
  }

  function detectDate() {
    // time[datetime], meta article:published_time, time with class published
    const metaTime = document.querySelector('meta[property="article:published_time"]')?.content ||
                     document.querySelector('meta[name="article:published_time"]')?.content;
    if(metaTime) return metaTime;
    const timeEl = firstMatch(['article time[datetime]', 'time[datetime]', '.published', '.publish-date', 'time']);
    if(timeEl) {
      const dt = timeEl.getAttribute('datetime') || textOrNull(timeEl);
      // try to parse
      const parsed = new Date(dt);
      if(!isNaN(parsed)) return parsed.toISOString();
      // if dt is string like "August 10, 2025", Date may parse it; fallback to now if fails
    }
    return null;
  }

  function detectPublisher() {
    // meta og:site_name or meta[name="publisher"]
    const site = document.querySelector('meta[property="og:site_name"]')?.content ||
                 document.querySelector('meta[name="publisher"]')?.content;
    return site || document.location.hostname;
  }

  function removeExistingInjected() {
    const existing = document.querySelectorAll('script[data-generated="news-ld"]');
    existing.forEach(s => s.remove());
  }

  function buildNewsArticleSchema() {
    const title = detectTitle();
    const desc = detectDescription();
    const image = detectPrimaryImage();
    const author = detectAuthor() || 'Staff';
    const pubDate = detectDate() || (new Date()).toISOString();
    const publisherName = detectPublisher();

    // Attempt to get publisher logo: meta og:logo (rare) or first favicon
    const logo = document.querySelector('meta[property="publisher:logo"]')?.content ||
                 document.querySelector('link[rel~="icon"]')?.href || '';

    const schema = {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": location.href
      },
      "headline": title || document.title,
      "image": image ? [image] : undefined,
      "datePublished": iso(pubDate) || new Date().toISOString(),
      "dateModified": iso(pubDate) || new Date().toISOString(),
      "author": {
        "@type": "Person",
        "name": author
      },
      "publisher": {
        "@type": "Organization",
        "name": publisherName,
        "logo": {
          "@type": "ImageObject",
          "url": logo || ''
        }
      },
      "description": desc || ''
    };

    // Remove undefined fields (clean)
    Object.keys(schema).forEach(k => {
      if(schema[k] === undefined || schema[k] === null) delete schema[k];
    });
    return schema;
  }

  function injectSchemaTag(jsonObj) {
    removeExistingInjected();
    const s = document.createElement('script');
    s.type = 'application/ld+json';
    s.dataset.generated = 'news-ld';
    // pretty print for debug; search engines don't mind whitespace
    s.text = JSON.stringify(jsonObj, null, 2);
    document.head.appendChild(s);
    // also show debug copy
    const dbg = document.getElementById('schemaDebug');
    if(dbg) dbg.textContent = s.text;
  }

  function generateAndInject() {
    try {
      const schema = buildNewsArticleSchema();
      injectSchemaTag(schema);
      console.log('NewsArticle schema generated:', schema);
    } catch (err) {
      console.error('Schema generation error', err);
    }
  }

  // Initial run
  generateAndInject();

  // If page loads content dynamically, watch for changes inside article
  const articleRoot = document.querySelector('article') || document.body;
  const observer = new MutationObserver((mutations) => {
    // debounce: small delay so many mutations coalesce
    if(window.__newsSchemaTimeout) clearTimeout(window.__newsSchemaTimeout);
    window.__newsSchemaTimeout = setTimeout(()=> {
      generateAndInject();
    }, 400);
  });
  observer.observe(articleRoot, { childList: true, subtree: true, attributes: true });

  // Expose a manual function if dev wants to call it
  window.generateNewsSchema = generateAndInject;
})();
</script>
</body>
</html>
